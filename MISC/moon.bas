10 REM *** MBASIC-80 LUNARCALC V3.1 ***
20 REM PHASE, ILLUMINATION, SUNRISE/SUNSET WITH LOCATION
30 REM C. VAN DER KAAY (2025)
40 PRINT CHR$(12)
50 PRINT TAB(10); "********************************************"
60 PRINT TAB(10); "*     MBASIC LUNARCALC V3.1  (C) 2025      *"
70 PRINT TAB(10); "*  MOON PHASE & SUNRISE/SUNSET CALCULATOR  *"
80 PRINT TAB(10); "********************************************"
90 REM *** USER INPUT ***
100 PRINT : PRINT "ENTER YEAR (E.G., 2025):"; : INPUT Y
110 IF Y < 0 THEN PRINT "INVALID YEAR. TRY AGAIN.": GOTO 100
120 PRINT "ENTER MONTH (1-12):"; : INPUT M
130 IF M < 1 THEN PRINT "INVALID MONTH. TRY AGAIN.": GOTO 120
140 IF M > 12 THEN PRINT "INVALID MONTH. TRY AGAIN.": GOTO 120
150 PRINT "ENTER DAY (1-31):"; : INPUT D
160 IF D < 1 THEN PRINT "INVALID DAY. TRY AGAIN.": GOTO 150
170 IF D > 31 THEN PRINT "INVALID DAY. TRY AGAIN.": GOTO 150
180 GOSUB 1270
190 PRINT "ENTER HOUR (UTC):"; : INPUT H
200 IF H < 0 THEN PRINT "INVALID HOUR. TRY AGAIN.": GOTO 190
210 IF H > 23 THEN PRINT "INVALID HOUR. TRY AGAIN.": GOTO 190
220 PRINT "ENTER MINUTE (UTC):"; : INPUT MN
230 IF MN < 0 THEN PRINT "INVALID MINUTE. TRY AGAIN.": GOTO 220
240 IF MN > 59 THEN PRINT "INVALID MINUTE. TRY AGAIN.": GOTO 220
250 PRINT "ENTER DELTA-T IN SECONDS (E.G., 69):"; : INPUT DTSEC
260 IF DTSEC < 0 THEN PRINT "INVALID DELTA-T. TRY AGAIN.": GOTO 250
270 DT = DTSEC / 86400!
280 PRINT : PRINT "ENTER LATITUDE (DECIMAL DEGREES, N=+ S=-):"; : INPUT LAT
290 IF LAT < -90 THEN PRINT "INVALID LATITUDE. TRY AGAIN.": GOTO 280
300 IF LAT > 90 THEN PRINT "INVALID LATITUDE. TRY AGAIN.": GOTO 280
310 PRINT "ENTER LONGITUDE (DECIMAL DEGREES, E=+ W=-):"; : INPUT LON
320 IF LON < -180 THEN PRINT "INVALID LONGITUDE. TRY AGAIN.": GOTO 310
330 IF LON > 180 THEN PRINT "INVALID LONGITUDE. TRY AGAIN.": GOTO 310
340 IF M <= 2 THEN Y = Y - 1: M = M + 12
350 A = INT(Y / 100)
360 B = 2 - A + INT(A / 4)
370 JD = INT(365.25 * (Y + 4716)) + INT(30.6001 * (M + 1)) + D + B - 1524.5
380 JD = JD + (H + MN / 60) / 24
390 RAD = 3.14159265# / 180
400 REM --- APPLY DELTA T (APPROX, IN DAYS)
410 JD = JD + DT
420 BASEJD = 2451550.1#
430 SYN = 29.530588853#
440 AGE = JD - BASEJD
450 T = INT(AGE / SYN)
460 REM *** MOON ELONGATION AND PHASE USING MEEUS APPROXIMATION ***
470 N = JD - 2451545!
480 G = 357.529 + .98560028# * N       ' SUN'S MEAN ANOMALY
490 G = G - INT(G / 360) * 360
500 LS = 280.459 + .98564736# * N      ' SUN'S MEAN LONGITUDE
510 LS = LS - INT(LS / 360) * 360
520 LS = LS + 1.915 * SIN(G * RAD) + .02 * SIN(2 * G * RAD)
530 MM = 134.963 + 13.064993# * N       ' MOON'S MEAN ANOMALY
540 MM = MM - INT(MM / 360) * 360
550 LM = 218.316 + 13.176396# * N       ' MOON'S MEAN LONGITUDE
560 LM = LM - INT(LM / 360) * 360
570 D = LM - LS
580 IF D < 0 THEN D = D + 360
590 IF D > 360 THEN D = D - INT(D / 360) * 360
600 REM *** ACCURATE ILLUMINATION USING ELONGATION D ***
610 COSI = COS(D * RAD)
620 K = (1 - COSI) / 2
630 ILL = INT(K * 100000! + .5) / 1000
640 REM *** PHASE NAME BY LUNAR AGE (MORE PRECISE)
650 AG = AGE - T * SYN
660 IF AG < 0 THEN AG = AG + SYN
670 IF AG < 1! THEN PH$ = "NEW MOON": GOTO 760
680 IF AG < 6! THEN PH$ = "WAXING CRESCENT": GOTO 760
690 IF AG < 7.5 THEN PH$ = "FIRST QUARTER": GOTO 760
700 IF AG < 13! THEN PH$ = "WAXING GIBBOUS": GOTO 760
710 IF AG < 15! THEN PH$ = "FULL MOON": GOTO 760
720 IF AG < 21! THEN PH$ = "WANING GIBBOUS": GOTO 760
730 IF AG < 22.5 THEN PH$ = "LAST QUARTER": GOTO 760
740 IF AG < 29! THEN PH$ = "WANING CRESCENT": GOTO 760
750 PH$ = "NEW MOON": GOTO 760
760 REM *** SOLAR DECLINATION FOR SUNRISE/SUNSET
770 N = JD - 2451545!
780 G = 357.529 + .98560028# * N
790 G = G - INT(G / 360) * 360
800 L = 280.459 + .98564736# * N
810 L = L - INT(L / 360) * 360
820 LAMBDA = L + 1.915 * SIN(G * RAD) + .02 * SIN(2 * G * RAD)
830 REM *** DECLINATION FROM LAMBDA
840 SINDECL = .39779 * SIN(LAMBDA * RAD)
850 TEMP = SINDECL
860 IF TEMP < -1 THEN TEMP = -1
870 IF TEMP > 1 THEN TEMP = 1
880 DECL = ATN(TEMP / SQR(1 - TEMP * TEMP)) / RAD
890 REM *** SUNRISE/SUNSET HOUR ANGLE (H0)
900 COSH0 = (COS(90.833 * RAD) - SIN(LAT * RAD) * SIN(DECL * RAD)) / (COS(LAT * RAD) * COS(DECL * RAD))
910 IF COSH0 > 1 THEN PRINT : PRINT "SUN NEVER RISES TODAY.": GOTO 1200
920 IF COSH0 < -1 THEN PRINT : PRINT "SUN NEVER SETS TODAY.": GOTO 1200
930 TEMP = COSH0
940 IF TEMP < -1 THEN TEMP = -1
950 IF TEMP > 1 THEN TEMP = 1
960 H0 = ATN(SQR(1 - TEMP * TEMP) / TEMP) / RAD
970 IF TEMP < 0 THEN H0 = H0 + 180
980 REM *** SUNRISE AND SUNSET (APPROX, UTC)
990 NOON = 12 - (LON / 15)
1000 SUNRISE = NOON - H0 / 15
1010 SUNSET = NOON + H0 / 15
1020 SN = 0
1030 IF SUNSET >= 24 THEN SUNSET = SUNSET - 24: SN = 1
1040 IF SUNSET < 0 THEN SUNSET = SUNSET + 24
1050 PRINT : PRINT "********************************************"
1060 PRINT "  JULIAN DAY:        "; INT(JD * 100 + .5) / 100
1070 PRINT "  MOON AGE:          "; INT(AG * 100 + .5) / 100; " DAYS"
1080 PRINT "  ILLUMINATION:      "; ILL; "%"
1090 PRINT "  PHASE:             "; PH$
1100 PRINT "********************************************"
1110 PRINT : PRINT "  SUNRISE (APPROX UTC): "; INT(SUNRISE * 60 + .5) / 60; " H"
1120 PRINT "  SUNSET  (APPROX UTC): "; INT(SUNSET * 60 + .5) / 60; " H";
1130 IF SN = 1 THEN PRINT " (NEXT DAY)" ELSE PRINT
1140 PRINT "********************************************"
1150 PRINT : PRINT "ANOTHER CALCULATION? (Y/N): "; : INPUT A$
1160 IF A$ = "Y" THEN GOTO 40
1170 IF A$ = "y" THEN GOTO 40
1180 PRINT : PRINT "THANK YOU FOR USING LUNARCALC V3.0"
1190 END
1200 PRINT "********************************************"
1210 PRINT "  JULIAN DAY:        "; INT(JD * 100 + .5) / 100
1220 PRINT "  MOON AGE:          "; INT(AGE * 100 + .5) / 100; " DAYS"
1230 PRINT "  ILLUMINATION:      "; ILL; "%"
1240 PRINT "  PHASE:             "; PH$
1250 PRINT "********************************************"
1260 GOTO 1150
1270 REM *** VALIDATE DAY BY MONTH AND LEAP YEAR ***
1280 IF M = 4 OR M = 6 OR M = 9 OR M = 11 THEN IF D > 30 THEN PRINT "THIS MONTH HAS ONLY 30 DAYS. TRY AGAIN.": GOTO 150
1290 IF M = 2 THEN GOSUB 1310
1300 RETURN
1310 REM *** LEAP YEAR CHECK FOR FEBRUARY ***
1320 LEAP = 0
1330 IF Y - INT(Y / 4) * 4 = 0 THEN LEAP = 1
1340 IF Y - INT(Y / 100) * 100 = 0 THEN LEAP = 0
1350 IF Y - INT(Y / 400) * 400 = 0 THEN LEAP = 1
1360 IF LEAP = 1 THEN IF D > 29 THEN PRINT "FEBRUARY HAS ONLY 29 DAYS IN LEAP YEARS. TRY AGAIN.": GOTO 150
1370 IF LEAP = 0 THEN IF D > 28 THEN PRINT "FEBRUARY HAS ONLY 28 DAYS. TRY AGAIN.": GOTO 150
1380 RETURN
